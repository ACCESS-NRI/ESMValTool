# recipe_anav13jclim.xml
---
documentation:

  description: |
    This recipe reproduces most of the figures of Anav et al. (2013).

  authors:
    - anav_al
    - wenz_sa
    - righ_ma
    - schl_ma

  references:
    - anav13jclim

  projects:
    - embrace


preprocessors:

  noop:
    {}

  landmask_and_regrid:
    mask_landsea:
      mask_out: sea
    regrid:
      target_grid: 2x2
      scheme: linear

  regridding:
    regrid:
      target_grid: 2x2
      scheme: linear

  landmask:
    mask_landsea:
      mask_out: sea

  grading:
    regrid:
      target_grid: ref_dataset
      regrid_scheme: linear
    mask_fillvalues: true

  regrid_to_ref:
    regrid:
      target_grid: reference_dataset
      scheme: linear
    mask_fillvalues:
      threshold_fraction: 0.95


diagnostics:

  diag_mvi_tas:
    description: MVI scatter plot for tas (Figure 1).
    themes:
      - phys
    realms:
      - atmos
    variables:
      tas: &landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: landmask_and_regrid
        project: CMIP5
        mip: Amon
        field: T2Ms
        exp: historical
        ensemble: r1i1p1
        start_year: 1901
        end_year: 2005
        reference_dataset: CRU
        plot_units: degC
    additional_datasets: &tas_datasets
      - {dataset: CRU, project: OBS, type: reanaly, version: 1, tier: 3}
      - {dataset: bcc-csm1-1}
      - {dataset: bcc-csm1-1-m}
      - {dataset: BNU-ESM}
      - {dataset: CanESM2}
      - {dataset: CESM1-BGC}
      - {dataset: GFDL-ESM2G}
      - {dataset: GFDL-ESM2M}
      - {dataset: HadGEM2-CC}
      - {dataset: HadGEM2-ES}
      - {dataset: inmcm4}
      - {dataset: IPSL-CM5A-LR}
      - {dataset: IPSL-CM5A-MR}
      # Overlapping files for several variables at mistral
      # - {dataset: IPSL-CM5B-LR}
      - {dataset: MIROC-ESM}
      - {dataset: MIROC-ESM-CHEM}
      - {dataset: MPI-ESM-LR}
      - {dataset: MPI-ESM-MR}
      - {dataset: NorESM1-ME}
    scripts:
      mvi_global: &mvi_global
        script: carbon_cycle/mvi.ncl
        legend_year_outside: true
        sort: true
        styleset: CMIP5
        region: Global
        mean_time_range: [1986, 2005]
        mvi_time_range: [1986, 2005]
      mvi_nh: &mvi_nh
        <<: *mvi_global
        region: Northern Hemisphere
      mvi_sh: &mvi_sh
        <<: *mvi_global
        region: Southern Hemisphere
      mvi_trop: &mvi_trop
        <<: *mvi_global
        region: Tropics

  diag_main_tas:
    description: Error bar, sasonal cycle and evolution plots for tas (Figure 1).
    themes:
      - phys
    realms:
      - atmos
    variables:
      tas:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: landmask
    additional_datasets: *tas_datasets
    scripts:
      main_global: &main_global
        script: carbon_cycle/main.ncl
        legend_year_outside: false
        legend_outside: false
        sort: true
        seasonal_cycle_plot: true
        errorbar_plot: true
        mean_IAV_plot: true
        styleset: CMIP5
        region: Global
        evolution_plot: true
        evolution_plot_volcanoes: true
        evolution_plot_ref_dataset: CRU
        evolution_plot_anomaly: true
      main_nh: &main_nh
        <<: *main_global
        region: Northern Hemisphere
      main_sh: &main_sh
        <<: *main_global
        region: Southern Hemisphere
      main_trop: &main_trop
        <<: *main_global
        region: Tropics

  diag_mvi_pr:
    description: MVI scatter plot for pr (Figure 2).
    themes:
      - phys
    realms:
      - atmos
    variables:
      pr:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        plot_units: mm yr-1
    additional_datasets: *tas_datasets
    scripts:
      mvi_global:
        <<: *mvi_global
      mvi_nh:
        <<: *mvi_nh
      mvi_sh:
        <<: *mvi_sh
      mvi_trop:
        <<: *mvi_trop

  diag_main_pr:
    description: Error bar, sasonal cycle and evolution plots for pr (Figure 2).
    themes:
      - phys
    realms:
      - atmos
    variables:
      pr:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: landmask
        plot_units: mm yr-1
    additional_datasets: *tas_datasets
    scripts:
      mvi_global:
        <<: *main_global
      mvi_nh:
        <<: *main_nh
      mvi_sh:
        <<: *main_sh
      mvi_trop:
        <<: *main_trop

  diag_mvi_tos:
    description: MVI scatter plot for tos (Figure 3).
    themes:
      - phys
    realms:
      - ocean
    variables:
      tos:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: regridding
        mip: Omon
        reference_dataset: HadISST
    additional_datasets: &tos_datasets
      - {dataset: HadISST, project: OBS, type: reanaly, version: 1, tier: 2}
      - {dataset: bcc-csm1-1}
      - {dataset: bcc-csm1-1-m}
      # No data
      # - {dataset: BNU-ESM}
      - {dataset: CanESM2}
      - {dataset: CESM1-BGC}
      - {dataset: GFDL-ESM2G}
      - {dataset: GFDL-ESM2M}
      - {dataset: HadGEM2-CC}
      - {dataset: HadGEM2-ES}
      - {dataset: inmcm4}
      - {dataset: IPSL-CM5A-LR}
      - {dataset: IPSL-CM5A-MR}
      - {dataset: IPSL-CM5B-LR}
      - {dataset: MIROC-ESM}
      - {dataset: MIROC-ESM-CHEM}
      - {dataset: MPI-ESM-LR}
      - {dataset: MPI-ESM-MR}
      - {dataset: NorESM1-ME}
    scripts:
      mvi_global:
        <<: *mvi_global
      mvi_nh:
        <<: *mvi_nh
      mvi_sh:
        <<: *mvi_sh
      mvi_trop:
        <<: *mvi_trop

  diag_main_tos:
    description: Error bar, sasonal cycle and evolution plots for pr (Figure 3).
    themes:
      - phys
    realms:
      - ocean
    variables:
      tos:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: regridding
        mip: Omon
        reference_dataset: HadISST
    additional_datasets: *tos_datasets
    scripts:
      main_global:
        <<: *main_global
        evolution_plot_ref_dataset: HadISST
      main_nh:
        <<: *main_nh
        evolution_plot_ref_dataset: HadISST
      main_sh:
        <<: *main_sh
        evolution_plot_ref_dataset: HadISST
      main_trop:
        <<: *main_trop
        evolution_plot_ref_dataset: HadISST

  diag_main_nbp:
    description: Error bar, sasonal cycle and evolution plots for nbp (Figures 5, 6, 7).
    themes:
      - phys
    realms:
      - land
    variables:
      nbp_grid:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: noop
        mip: Lmon
        reference_dataset: JMA-TRANSCOM
        plot_units: PgC y-1
        derive: true
        additional_datasets:
          - {dataset: GCP, project: OBS, type: reanaly, version: 1, tier: 2, start_year: 1959, end_year: 2015}
    additional_datasets: &nbp_datasets
      - {dataset: JMA-TRANSCOM, project: OBS, type: reanaly, version: 1, tier: 3, start_year: 1986, end_year: 2005}
      - {dataset: BNU-ESM}
      - {dataset: CanESM2}
      - {dataset: CESM1-BGC}
      - {dataset: GFDL-ESM2G}
      - {dataset: GFDL-ESM2M}
      - {dataset: HadGEM2-CC}
      - {dataset: HadGEM2-ES}
      - {dataset: inmcm4}
      - {dataset: IPSL-CM5A-LR}
      - {dataset: IPSL-CM5A-MR}
      # Overlapping files for several variables at mistral
      # - {dataset: IPSL-CM5B-LR}
      - {dataset: MIROC-ESM}
      - {dataset: MIROC-ESM-CHEM}
      - {dataset: MPI-ESM-LR}
      - {dataset: MPI-ESM-MR}
      - {dataset: NorESM1-ME}
    scripts:
      main_global:
        <<: *main_global
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
        anav_month: true
      main_nh:
        <<: *main_nh
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
        anav_month: true
      main_sh:
        <<: *main_sh
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
        anav_month: true
      main_trop:
        <<: *main_trop
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
        anav_month: true

  diag_mvi_lai:
    description: MVI scatter plot for lai (Figure 10).
    themes:
      - phys
    realms:
      - land
    variables:
      lai_grid: &regrid_Lmon_1986_2005_refLAI3g
        preprocessor: regridding
        project: CMIP5
        mip: Lmon
        field: T2Ms
        exp: historical
        ensemble: r1i1p1
        start_year: 1986
        end_year: 2005
        reference_dataset: LAI3g
        derive: true
    additional_datasets: &lai_datasets
      - {dataset: LAI3g, project: OBS, type: reanaly, version: 1, tier: 3}
      - {dataset: bcc-csm1-1}
      - {dataset: bcc-csm1-1-m}
      - {dataset: BNU-ESM}
      - {dataset: CanESM2}
      - {dataset: CESM1-BGC}
      - {dataset: GFDL-ESM2G}
      - {dataset: GFDL-ESM2M}
      - {dataset: HadGEM2-CC}
      - {dataset: HadGEM2-ES}
      - {dataset: inmcm4}
      - {dataset: IPSL-CM5A-LR}
      - {dataset: IPSL-CM5A-MR}
      # Overlapping files for several variables at mistral
      # - {dataset: IPSL-CM5B-LR}
      - {dataset: MIROC-ESM}
      - {dataset: MIROC-ESM-CHEM}
      - {dataset: MPI-ESM-LR}
      - {dataset: MPI-ESM-MR}
      - {dataset: NorESM1-ME}
    scripts:
      mvi_global:
        <<: *mvi_global
      mvi_nh:
        <<: *mvi_nh
      mvi_sh:
        <<: *mvi_sh
      mvi_trop:
        <<: *mvi_trop

  diag_main_lai:
    description: Error bar, sasonal cycle and evolution plots for lai (Figure 11).
    themes:
      - phys
    realms:
      - land
    variables:
      lai_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        preprocessor: noop
    additional_datasets: *lai_datasets
    scripts:
      main_global:
        <<: *main_global
        evolution_plot_ref_dataset: LAI3g
        evolution_plot_anomaly: false
      main_nh:
        <<: *main_nh
        evolution_plot_ref_dataset: LAI3g
        evolution_plot_anomaly: false
      main_sh:
        <<: *main_sh
        evolution_plot_ref_dataset: LAI3g
        evolution_plot_anomaly: false
      main_trop:
        <<: *main_trop
        evolution_plot_ref_dataset: LAI3g
        evolution_plot_anomaly: false

  diag_mvi_gpp:
    description: MVI scatter plot for gpp (Figure 8).
    themes:
      - phys
    realms:
      - land
    variables:
      gpp_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        reference_dataset: MTE
        plot_units: PgC y-1
    additional_datasets: &gpp_datasets
      - {dataset: MTE, project: OBS, type: reanaly, version: 1, tier: 2}
      - {dataset: bcc-csm1-1}
      - {dataset: bcc-csm1-1-m}
      - {dataset: BNU-ESM}
      - {dataset: CanESM2}
      - {dataset: CESM1-BGC}
      - {dataset: GFDL-ESM2G}
      - {dataset: GFDL-ESM2M}
      - {dataset: HadGEM2-CC}
      - {dataset: HadGEM2-ES}
      - {dataset: inmcm4}
      - {dataset: IPSL-CM5A-LR}
      - {dataset: IPSL-CM5A-MR}
      # Overlapping files for several variables at mistral
      # - {dataset: IPSL-CM5B-LR}
      - {dataset: MIROC-ESM}
      - {dataset: MIROC-ESM-CHEM}
      - {dataset: MPI-ESM-LR}
      - {dataset: MPI-ESM-MR}
      - {dataset: NorESM1-ME}
    scripts:
      mvi_global:
        <<: *mvi_global
      mvi_nh:
        <<: *mvi_nh
      mvi_sh:
        <<: *mvi_sh
      mvi_trop:
        <<: *mvi_trop

  diag_main_gpp:
    description: Error bar, sasonal cycle and evolution plots for gpp (Figure 9).
    themes:
      - phys
    realms:
      - land
    variables:
      gpp_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        preprocessor: noop
        reference_dataset: MTE
        plot_units: PgC y-1
    additional_datasets: *gpp_datasets
    scripts:
      main_global:
        <<: *main_global
        evolution_plot_ref_dataset: MTE
        evolution_plot_anomaly: false
      main_nh:
        <<: *main_nh
        evolution_plot_ref_dataset: MTE
        evolution_plot_anomaly: false
      main_sh:
        <<: *main_sh
        evolution_plot_ref_dataset: MTE
        evolution_plot_anomaly: false
      main_trop:
        <<: *main_trop
        evolution_plot_ref_dataset: MTE
        evolution_plot_anomaly: false

  diag_two_vars_scatter:
    description: Two-variable scatter plot for cSoil and cVeg (Figure 12).
    themes:
      - phys
    realms:
      - land
    variables:
      cSoil_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        reference_dataset: HWSD
        plot_units: PgC
        additional_datasets:
          - {dataset: HWSD, project: OBS, type: ground, version: 1, start_year: 2000, end_year: 2000, tier: 2}
      cVeg_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        reference_dataset: NDP
        plot_units: PgC
        additional_datasets:
          - {dataset: NDP, project: OBS, type: ground, version: 017b, start_year: 2000, end_year: 2000, tier: 2}
    additional_datasets:
      - {dataset: BNU-ESM}
      # - {dataset: CanESM2}
      - {dataset: CESM1-BGC}
      - {dataset: GFDL-ESM2G}
      - {dataset: GFDL-ESM2M}
      - {dataset: HadGEM2-CC}
      - {dataset: HadGEM2-ES}
      # - {dataset: inmcm4}
      - {dataset: IPSL-CM5A-LR}
      - {dataset: IPSL-CM5A-MR}
      # Overlapping files for several variables at mistral
      # - {dataset: IPSL-CM5B-LR}
      - {dataset: MIROC-ESM}
      - {dataset: MIROC-ESM-CHEM}
      - {dataset: MPI-ESM-LR}
      - {dataset: MPI-ESM-MR}
      - {dataset: NorESM1-ME}
    scripts:
      scat_global: &scat_glob
        script: carbon_cycle/two_variables.ncl
        legend_year_outside: false
        styleset: CMIP5
        region: Global
      scat_nh:
        <<: *scat_glob
        region: Northern Hemisphere
      scat_sh:
        <<: *scat_glob
        region: Southern Hemisphere
      scat_trop:
        <<: *scat_glob
        region: Tropics

  diag_main_fgco2:
    description: Error bar, sasonal cycle and evolution plots for fgco2 (Figure 13, 14, 15).
    themes:
      - phys
    realms:
      - ocean
    variables:
      fgco2_grid:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: regridding
        mip: Omon
        reference_dataset: JMA-TRANSCOM
        plot_units: PgC y-1
        derive: true
        additional_datasets:
          - {dataset: JMA-TRANSCOM, project: OBS, type: reanaly, version: 1, tier: 3, start_year: 1986, end_year: 2005}
          # No data
          # - {dataset: BNU-ESM}
          - {dataset: CanESM2}
          - {dataset: CESM1-BGC}
          - {dataset: GFDL-ESM2G}
          - {dataset: GFDL-ESM2M}
          - {dataset: HadGEM2-CC}
          - {dataset: HadGEM2-ES}
          - {dataset: inmcm4}
          - {dataset: IPSL-CM5A-LR}
          - {dataset: IPSL-CM5A-MR}
          - {dataset: IPSL-CM5B-LR}
          # Shape of fx files and fgco2 differ on mistral
          # - {dataset: MIROC-ESM}
          # - {dataset: MIROC-ESM-CHEM}
          - {dataset: MPI-ESM-LR}
          - {dataset: MPI-ESM-MR}
          - {dataset: NorESM1-ME}
      fgco2_grid_GCP:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        short_name: fgco2_grid
        preprocessor: noop
        mip: Omon
        reference_dataset: JMA-TRANSCOM
        plot_units: PgC y-1
        derive: true
        additional_datasets:
          - {dataset: GCP, project: OBS, type: reanaly, version: 1, tier: 2, start_year: 1959, end_year: 2015}
    scripts:
      main_global:
        <<: *main_global
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
      main_nh:
        <<: *main_nh
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
      main_sh:
        <<: *main_sh
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false
      main_trop:
        <<: *main_trop
        evolution_plot_ref_dataset: GCP
        evolution_plot_anomaly: false

  diag_grading_tas: &diag_grading
    description: Grading precalculations for tas.
    themes:
      - phys
    realms:
      - atmos
    variables:
      tas:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: regrid_to_ref
        start_year: 1986
    additional_datasets: *tas_datasets
    scripts:
      cycle_global: &cycle_global
        script: perfmetrics/main.ncl
        plot_type: cycle_latlon
        time_avg: monthlyclim
        region: Global
        plot_stddev: all
        legend_outside: false
        styleset: CMIP5
      cycle_nh: &cycle_nh
        <<: *cycle_global
        region: Northern Hemisphere
      cycle_sh: &cycle_sh
        <<: *cycle_global
        region: Southern Hemisphere
      cycle_trop: &cycle_trop
        <<: *cycle_global
        region: Tropics
      grading_global: &grading_global
        <<: *cycle_global
        draw_plots: true
        calc_grading: true
        metric: [RMSD]
        normalization: [maximum]
      grading_nh: &grading_nh
        <<: *grading_global
        region: Northern Hemisphere
      grading_sh: &grading_sh
        <<: *grading_global
        region: Southern Hemisphere
      grading_trop: &grading_trop
        <<: *grading_global
        region: Tropics

  diag_grading_pr:
    <<: *diag_grading
    description: Grading precalculations for pr.
    variables:
      pr:
        <<: *landmaskregrid_Amon_1901_2005_refCRU
        preprocessor: regrid_to_ref
        start_year: 1986
    additional_datasets: *tas_datasets
    scripts:
      cycle_global:
        <<: *cycle_global
      cycle_nh:
        <<: *cycle_nh
      cycle_sh:
        <<: *cycle_sh
      cycle_trop:
        <<: *cycle_trop
      grading_global:
        <<: *grading_global
      grading_nh:
        <<: *grading_nh
      grading_sh:
        <<: *grading_sh
      grading_trop:
        <<: *grading_trop

  diag_grading_nbp:
    <<: *diag_grading
    description: Grading precalculations for nbp.
    realms:
      - land
    variables:
      nbp_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        preprocessor: regrid_to_ref
        reference_dataset: JMA-TRANSCOM
    additional_datasets: *nbp_datasets
    scripts:
      cycle_global:
        <<: *cycle_global
      cycle_nh:
        <<: *cycle_nh
      cycle_sh:
        <<: *cycle_sh
      cycle_trop:
        <<: *cycle_trop
      grading_global:
        <<: *grading_global
      grading_nh:
        <<: *grading_nh
      grading_sh:
        <<: *grading_sh
      grading_trop:
        <<: *grading_trop

  diag_grading_lai:
    <<: *diag_grading
    description: Grading precalculations for lai.
    realms:
      - land
    variables:
      lai_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        preprocessor: regrid_to_ref
    additional_datasets: *lai_datasets
    scripts:
      cycle_global:
        <<: *cycle_global
      cycle_nh:
        <<: *cycle_nh
      cycle_sh:
        <<: *cycle_sh
      cycle_trop:
        <<: *cycle_trop
      grading_global:
        <<: *grading_global
      grading_nh:
        <<: *grading_nh
      grading_sh:
        <<: *grading_sh
      grading_trop:
        <<: *grading_trop

  diag_grading_gpp:
    <<: *diag_grading
    description: Grading precalculations for gpp.
    realms:
      - land
    variables:
      gpp_grid:
        <<: *regrid_Lmon_1986_2005_refLAI3g
        preprocessor: regrid_to_ref
        reference_dataset: MTE
    additional_datasets: *gpp_datasets
    scripts:
      cycle_global:
        <<: *cycle_global
      cycle_nh:
        <<: *cycle_nh
      cycle_sh:
        <<: *cycle_sh
      cycle_trop:
        <<: *cycle_trop
      grading_global:
        <<: *grading_global
      grading_nh:
        <<: *grading_nh
      grading_sh:
        <<: *grading_sh
      grading_trop:
        <<: *grading_trop

  diag_collect:
    <<: *diag_grading
    description: Collect and plot previously calculated performance metrics.
    realms:
      - atmos
      - land
    scripts:
      collect_global: &collect_global
        script: perfmetrics/collect.ncl
        ancestors: ['diag_grading_*/grading_global']
        metric: RMSD
        label_bounds: [0.0, 1.0]
        label_scale: 0.1
        disp_value: false
        disp_rankings: true
        rank_order: -1
        colormap: matlab_jet
        cm_reverse: true
        cm_interval: [2, 63]
        sort: true
      collect_nh:
        <<: *collect_global
        ancestors: ['diag_grading_*/grading_nh']
      collect_sh:
        <<: *collect_global
        ancestors: ['diag_grading_*/grading_sh']
      collect_trop:
        <<: *collect_global
        ancestors: ['diag_grading_*/grading_trop']
